package test;

import com.alibaba.dubbo.performance.demo.nettyagent.codec.CacheRequestDecoder;
import com.alibaba.dubbo.performance.demo.nettyagent.model.FuncType;
import com.alibaba.dubbo.performance.demo.nettyagent.util.CacheContext;
import io.netty.buffer.ByteBuf;
import io.netty.buffer.ByteBufUtil;
import io.netty.buffer.Unpooled;
import io.netty.channel.embedded.EmbeddedChannel;
import org.junit.Test;

import java.util.concurrent.ConcurrentHashMap;

/**
 * Created by gexinjie on 2018/6/11.
 */
public class CacheRequestDecoderTest {
    @Test
    public void decode() throws Exception {
//        String hexdump = "dacc800000000000000000fe00000062686173680a4c6a6176612f6c616e672f537472696e673b0a636f6d2e616c69626162612e647562626f2e706572666f726d616e63652e64656d6f2e70726f76696465722e4948656c6c6f536572766963650adacc800000000000000000ff00000325686173680a4c6a6176612f6c616e672f537472696e673b0a636f6d2e616c69626162612e647562626f2e706572666f726d616e63652e64656d6f2e70726f76696465722e4948656c6c6f536572766963650a55676559337a736a714a366d54307a6b6a7962584b7732647467463151615835345772396e6646567a44356d6e58704775355a4e566a5131435569474c695277564230537035506c4b654e484c646d6e3179747a334d764d61396359304e78696a5447415a3450796f4c4f54355648306f724b3649315470796b656c6c6351584a4b354b4b676d4d524d51494f5436427946624552";
//        String hexdump = "daccc000000000000000030c0000023b000000175a4a755348734c516e3242734176656475766b39516865566649647473734133694f5030486357545a754737337179527473706d646b4f5a5a69305a726d457833556478727030344f476f594a4f626d4f3466504a4257795a525462534a514b633142455a446c6632445734783361624e5245524f64724d3057726f674b6b50504961316f545166394f306b394470413442675654454a5a4739615932797379745670653566764e3861425649433670636c69616d634d63766c354a715339694f486a4d5477516f7446503155514969486f304138697264734f563431664e674a4178707530414f6b5156355841436d7a51703465506155366231617448787848724d4d35513642576f5851324f6f7a334672314d4c376e4553623842437944596c4d54644738534c6c584d46476f63776c3775756c3852497a4f336d49345a4d41774e753958756a684c3139726e42633446733837454b384b5357636c786f363551487436476670657851516b314d746c387353756d424451636732656f466b4f3046626e6f484936797358744669484a494e617037474e70433557354e6f4b4152636c654744446d4d4b337263665a38424778656564426e4d584e375633634a7746456e623955544f6148464165336d7838303730587755344f795733316136374f6b77546c3558667130376e7142776c6746346f66364a6246464930427746417548775a3535454948697835637a31364c3741324676496a7437774c6c4c434537506d69";
//        String hexdump = "dacc8000000000000000036500000062686173680a4c6a6176612f6c616e672f537472696e673b0a636f6d2e616c69626162612e647562626f2e706572666f726d616e63652e64656d6f2e70726f76696465722e4948656c6c6f536572766963650a";
        String hexdump = "daccc000000000000000052f0000021800000018444872306336544e386d4c6c6e76777a5a6c476737704447365773624b4547545458676c6366616d673163675a6d4b3979754a3039376975326d414c5866506474334b4c744943324b6f52694d6f766f784e6e70337639785a4a457837444179726a37636c3779556c6f704c6547796478413054596d776d766b30736b4e65744258654a46715049637964784856726e35435171334e6546616a47656a6f556472614e4d50503570535837666f75333355747168575856436a46775469695a783274784b536e42374e7a654a35444e30664937765059395831706478457445776432464666545570304558316f416c52493235723261445649496172514f7772494a477a545a5a6c49565656577a6f644c417a644c6636355856586d334143794e51624e6e3374365641577350573365745650413765784f736e6c4243304970364735327739583359534956736f66694c336b7939756e6d6b326653645276736865757179536a4f5736777541304d746f39585176454b4a366c37354877367578797250746148616e4e47413044374a4f766361504876455339386f5173626f4c4542303543373463306b71457646615647496c61613177377951743978316e6853386c39453350336b376972504a4e7a594d4a4a677351615736476969473578734e4d3461565647707153346f616f73706354725a6b72416444365741524142434665daccc0000000000000000530000002a5000000184e3850747542506d57556e5870646b41753577744b516c6e5249466953746539436339427a68305a534c3075676353786f67765545563238426d5257386c6c7353627865614b68384c644452674e43324d7a674345656e6b326d6f35467376484c6632425277493551335a34554c794841744d4378674548366133687471716e75716d4462467448535a42675667355a314c7272324d5958326d58425375687a466e697732696741317032614a62364d724a7155496f61523470736a6139565a4b6d6b7a6f666435585051744230756c627737306c63496c705534766b356f67754458324865526c4249533569556645695879357172474d783738315a644d326f7445456a454a625976465948456d337542624e3356693761626e50784835784e4169686173704372794d654376727a5a774d4d516c54496765613269754251394d616d656a7a69725344586a387869693755495a4b5668475a4b615233496845614c4647626b4162686961596b774753534f4b69357a565059444a5a48524838377a305a38314d727573584c505248637a5a5372576e796d38754639463442564e3767344336784c6377764635574653714278555050714f5348783433734872546b47674b4b79657533717a6e76526d3667717266383336415579477076687459577955793568693775566f686437684446444c4d4d356367333072317758576d7847454d6a424f34386e485761627977767259585152344f6f6b665971464b3756535a546263536e70354438574662375556584e6763484a577136734155453256545951577a696c427751694d30635762327478506d554b53703468734c5a306d647361714649746638643544764662564b47434a45496730374e47737a6f54547a3658447158443067717a745674daccc00000000000000005310000002d00000018737a5544424d376a4532436b4f544776364b4e3559634c7633";

        byte[] requestByte = ByteBufUtil.decodeHexDump(hexdump);
        ByteBuf requestBuf = Unpooled.wrappedBuffer(requestByte);

        FuncType type = new FuncType();
        type.setInterfaceName("com.alibaba.dubbo.performance.demo.provider.IHelloService");
        type.setParameterTypes("Ljava/lang/String;");
        type.setMethodName("hash");
        CacheContext cacheContext = new CacheContext();
        cacheContext.put(type, 23);
        ConcurrentHashMap<Long, Integer> requestToMethodFirstCache = new ConcurrentHashMap<>();


        EmbeddedChannel PADecodeChannel = new EmbeddedChannel(
                new CacheRequestDecoder(cacheContext, requestToMethodFirstCache)
        );

        PADecodeChannel.writeInbound(requestBuf);

    }

}